<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet"> <!-- Flatpickr CSS -->
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-image: radial-gradient(circle, #000227, #2E0043, rgb(2, 8, 21));
            margin: 0;
            padding: 30px;
            color: #fff;
        }

        h2 {
            text-align: center;
            color: #ffffff;
        }

        .dashboard-container {
            max-width: 900px;
            margin: auto;
        }

        .employee-id {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .card {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .card h3 {
            margin-top: 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            color: white;
        }

        .card h3 i {
            margin-right: 8px;
            color: #ffffff;
        }

        .status {
            margin-top: 10px;
            color: #28a745;
        }

        .status.danger {
            color: #dc3545;
        }

        .status.success {
            color: #28a745;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            font-size: 13px;
            border-radius: 12px;
            margin-left: 10px;
            vertical-align: middle;
        }

        .status-late {
            background-color: #f8d7da;
            color: #dc3545;
        }

        .status-on-time {
            background-color: #d4edda;
            color: #28a745;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #3b5bdb;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
        }

        .btn-primary:hover,
        .btn-danger:hover {
            opacity: 0.9;
        }

        textarea,
        select,
        input[type="date"] {
            background-color: rgba(255, 255, 255, 0.9);
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #ccc;
            resize: vertical;
        }

        #leave-form {
            display: none;
        }

        #history-options {
            display: none;
            margin-top: 15px;
        }

        form {
            margin-top: 10px;
        }


    </style>
</head>
<body>
    <div class="dashboard-container">
        <h2>Welcome, {{ employee.name }}</h2>
        <div class="employee-id">Employee ID: {{ employee.employee_id }}</div>

        <!-- Attendance -->
        <div class="card">
            <h3><i class="fa fa-calendar-check"></i> Today's Attendance</h3>
            <hr>
            {% if status == "Leave" %}
                <div class="status success">
                    <i class="fa fa-plane-departure"></i> Leave Approved for Today
                </div>
            {% elif attendance.check_in %}
                <div class="status success">
                    <i class="fa fa-sign-in-alt"></i> Checked In: {{ attendance.check_in }}
                    {% if status == "Late" %}
                        <span class="status-badge status-late">Late</span>
                    {% elif status == "On Time" %}
                        <span class="status-badge status-on-time">On Time</span>
                    {% else %}
                        <span class="status-badge status-half-day">Half Day</span>
                    {% endif %}
                </div>
                {% if attendance.check_out %}
                    <div class="status success">
                        <i class="fa fa-sign-out-alt"></i> Checked Out: {{ attendance.check_out }}
                    </div>
                {% endif %}
            {% else %}
                <div class="status danger"><i class="fa fa-ban"></i> Not Checked In</div>
            {% endif %}
        </div>


        <div class="card">
            <h3><i class="fa fa-mug-hot"></i> Break Status</h3>
            <hr>
            {% if attendance.check_out %}
                <div class="status danger"><i class="fa fa-ban"></i> You have already checked out. Breaks are not allowed.</div>
            {% else %}
                {% if break %}
                    {% if break.break_start %}
                        <div class="status success">âœ” Break Started at {{ break.break_start }}</div>
                        {% if break.break_end %}
                            <div class="status success">âœ” Break Ended at {{ break.break_end }}</div>
                            <form method="post" action="/start_break/">{% csrf_token %}
                                <button class="btn-primary" type="submit">Start Break</button>
                            </form>
                        {% else %}
                            <form method="post" action="/end_break/">{% csrf_token %}
                                <button class="btn-danger" type="submit">Stop Break</button>
                            </form>
                        {% endif %}
                    {% endif %}
                {% else %}
                    <div class="status danger"><i class="fa fa-ban"></i> No Break Started</div>
                    <form method="post" action="/start_break/">{% csrf_token %}
                        <button class="btn-primary" type="submit">Start Break</button>
                    </form>
                {% endif %}
            {% endif %}
        </div>


        <!-- Leave Request -->
        <div class="card">
            <h3><i class="fa fa-paper-plane"></i> Leave Request</h3>
            <hr>
            <button class="btn-danger" onclick="toggleLeaveForm()">Request Leave</button>

            <form method="post" action="/request_leave/" id="leave-form">{% csrf_token %}
                <label for="leave_type">Leave Type:</label>
                <select id="leave_type" name="leave_type" required onchange="updateRemaining()">
                    <option value="">-- Select Leave Type --</option>
                    <option value="Sick Leave">Sick Leave</option>
                    <option value="Emergency Leave">Emergency Leave</option>
                    <option value="Vacation Leave">Vacation Leave</option>
                    <option value="Personal Leave">Personal Leave</option>
                </select>

                <div id="remaining-display" style="color:white; margin-bottom:10px;"></div>

                <label for="start_date">Start Date:</label>
                <input type="text" id="start_date" name="start_date" required> <!-- Changed to text for Flatpickr -->

                <label for="end_date">End Date:</label>
                <input type="text" id="end_date" name="end_date" required> <!-- Changed to text for Flatpickr -->

                <label for="reason">Reason for Leave:</label>
                <textarea id="reason" name="reason" rows="3" required></textarea>

                <button class="btn-danger" type="submit">Send Request</button>
                <div id="leave-response" style="margin-top: 10px; padding: 10px; border-radius: 6px; display:none;"></div>
            </form>

            {% if latest_leave %}
<!--                <div class="status {% if latest_leave.status == 'Approved' %}success{% else %}danger{% endif %}">-->
<!--                    <i class="fa fa-info-circle"></i> Latest Leave Status: {{ latest_leave.status }}<br>-->
<!--                    <strong>Leave Type:</strong> {{ latest_leave.leave_type }}-->
<!--                </div>-->
            {% endif %}
        </div>





    <div style="
    position: fixed;
    top: 150px;
    left: 30px;
    width: 200px;
    z-index: 999;
">
    <div class="card">
        <h3><i class="fa fa-history"></i> History</h3>
        <hr>
        <button class="btn-primary" onclick="toggleHistoryOptions()">View History</button>

        <div id="history-options">
            <form action="/leave_history/" method="get" style="margin-bottom: 10px;">
                <button class="btn-primary" type="submit">Leave History</button>
            </form>
            <form action="/attendance_history/" method="get">
                <button class="btn-primary" type="submit">Attendance History</button>
            </form>
        </div>
    </div>
</div>


    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script> <!-- Flatpickr JS -->
    <script>

    function toggleLeaveForm() {
        const form = document.getElementById("leave-form");
        if (form.classList.contains("show")) {
            form.style.display = "none";
            form.classList.remove("show");
        } else {
            form.style.display = "block";
            form.classList.add("show");
        }
    }

    function toggleHistoryOptions() {
        const options = document.getElementById("history-options");
        if (options.classList.contains("show")) {
            options.style.display = "none";
            options.classList.remove("show");
        } else {
            options.style.display = "block";
            options.classList.add("show");
        }
    }

        function updateRemaining() {
            const selected = document.getElementById("leave_type").value;
            const remaining = {
                "Sick Leave": {{ leave_balances.Sick|default:"8" }},
                "Emergency Leave": {{ leave_balances.Emergency|default:"8" }},
                "Vacation Leave": {{ leave_balances.Vacation|default:"8" }},
                "Personal Leave": {{ leave_balances.Personal|default:"8" }}
            };
            const display = document.getElementById("remaining-display");
            display.innerHTML = selected ? `Remaining ${selected}: ${remaining[selected]}` : '';
        }

        // Initialize Flatpickr for start_date and end_date with calendar-style UI
        flatpickr("#start_date", {
            dateFormat: "Y-m-d", // Format date as YYYY-MM-DD
            minDate: "today",    // Prevent selecting past dates
            allowInput: true     // Allow typing in the input as well as picking dates
        });

        flatpickr("#end_date", {
            dateFormat: "Y-m-d", // Format date as YYYY-MM-DD
            minDate: "today",    // Prevent selecting past dates
            allowInput: true     // Allow typing in the input as well as picking dates
        });
       document.getElementById('leave-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);
    const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

    try {
        const response = await fetch(form.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
            },
            body: formData,
        });

        const text = await response.text();

        if (response.ok) {
            showModal('Leave request submitted!', text, true);
            form.reset();
            form.style.display = 'none';
        } else {
            showModal('Error', text, false);
        }
    } catch (error) {
        showModal('Error', 'An error occurred. Please try again.', false);
    }
});



        function showModal(title, message, isSuccess = true) {
    const modal = document.getElementById('response-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalIcon = document.getElementById('modal-icon');

    modalTitle.textContent = title;
    modalMessage.textContent = message;

    if (isSuccess) {
        modalIcon.innerHTML = '<i class="fa fa-check-circle"></i>';
        modalIcon.style.color = '#28a745';  // green
    } else {
        modalIcon.innerHTML = '<i class="fa fa-times-circle"></i>';
        modalIcon.style.color = '#dc3545';  // red
    }

    modal.style.display = 'flex';
}

function closeModal() {
    document.getElementById('response-modal').style.display = 'none';
}

    </script>
<!-- Modal -->
<div id="response-modal" style="
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(5px);
    justify-content: center;
    align-items: center;
">
    <div style="
        background: white;
        color: #333;
        border-radius: 12px;
        max-width: 400px;
        padding: 30px 40px;
        text-align: center;
        box-shadow: 0 8px 16px rgba(0,0,0,0.25);
        position: relative;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    ">
        <div id="modal-icon" style="font-size: 50px; color: #28a745; margin-bottom: 20px;">
            <i class="fa fa-check-circle"></i>
        </div>
        <h2 id="modal-title" style="margin-bottom: 10px;">Leave request submitted!</h2>
        <p id="modal-message" style="color: #555;">Leave request submitted successfully.</p>
        <button onclick="closeModal()" style="
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 25px;
            width: 100%;
        ">OK</button>
    </div>
</div>

</body>
</html>





from django.http import HttpResponse
# from django.http import JsonResponse
from django.utils.timezone import localdate
# from .models import Attendance, Break
# from reportlab.lib.pagesizes import A4
# from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer
# from reportlab.lib import colors
# from reportlab.lib.styles import getSampleStyleSheet
# from .models import Attendance, Employee
# from django.http import HttpResponse
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle
from reportlab.lib.pagesizes import A4
from reportlab.lib.styles import getSampleStyleSheet
from reportlab.lib import colors
# from .forms import AttendanceReportForm
# from datetime import datetime
from django.contrib.auth.hashers import check_password
# from django.http import HttpResponse
# from django.utils.timezone import localdate
# from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle
# from reportlab.lib.pagesizes import A4
# from reportlab.lib.styles import getSampleStyleSheet
# from reportlab.lib import colors
# from datetime import datetime
# from django.http import HttpResponse
# from .models import Attendance, Employee
# from django.conf import settings
# from django.shortcuts import render, redirect
from datetime import datetime





from django.shortcuts import render, redirect
from django.utils.timezone import localdate
from .models import Employee, Attendance






















<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quick View Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    main {
      max-width: 1000px;
      margin: 0 auto;
    }
    .stats {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .card {
      background: white;
      border-radius: 6px;
      padding: 20px;
      flex: 1 1 140px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 2px 4px rgb(0 0 0 / 0.1);
      transition: background 0.3s ease;
      user-select: none;
    }
    .card.active {
      background: #007bff;
      color: white;
      font-weight: bold;
    }
    .card h2 {
      margin: 0 0 5px;
      font-size: 2.2em;
    }
    .card p {
      margin: 0;
      font-size: 1em;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    #departmentFilter {
      margin-bottom: 20px;
      padding: 8px;
      font-size: 1em;
      border-radius: 4px;
      border: 1px solid #ccc;
      width: 220px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgb(0 0 0 / 0.1);
    }
    th, td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    th {
      background: #007bff;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    tr:hover {
      background: #f0f8ff;
    }
    .birthday {
      font-weight: bold;
      color: #ff5722;
    }
  </style>
</head>
<body>
  <main>
    <div class="stats">
      <div class="card active" data-status="all">
        <h2 id="totalEmployees">0</h2>
        <p>Total Employees</p>
      </div>
      <div class="card" data-status="present">
        <h2 id="present">0</h2>
        <p>Present</p>
      </div>
      <div class="card" data-status="absent">
        <h2 id="absent">0</h2>
        <p>Absent</p>
      </div>
      <div class="card" data-status="onBreak">
        <h2 id="onBreak">0</h2>
        <p>On Break</p>
      </div>
      <div class="card" data-status="onLeave">
        <h2 id="onLeave">0</h2>
        <p>On Leave</p>
      </div>
      <div class="card" data-status="weekend">
        <h2 id="weekend">0</h2>
        <p>Weekend</p>
      </div>
    </div>

    <select id="departmentFilter" aria-label="Filter by Department">
      <option value="all">All Departments</option>
    </select>

    <table aria-label="Employee Attendance Table">
      <thead>
        <tr>
          <th>Employee ID</th>
          <th>Name</th>
          <th>Department</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="employeeList">
        <!-- Populated dynamically -->
      </tbody>
    </table>
  </main>

  <script>
    const employeeList = document.getElementById("employeeList");
    const stats = {
      total: document.getElementById("totalEmployees"),
      present: document.getElementById("present"),
      absent: document.getElementById("absent"),
      onBreak: document.getElementById("onBreak"),
      onLeave: document.getElementById("onLeave"),
      weekend: document.getElementById("weekend"),
    };

    const employees = {};
    const departmentFilter = document.getElementById("departmentFilter");
    let selectedStatus = "all";

    function isTodayTimestamp(timestamp) {
      if (!timestamp) return false;
      const ts = new Date(timestamp);
      const now = new Date();

      const dayStart = new Date(now);
      dayStart.setHours(12, 0, 0, 0);

      const nextDayStart = new Date(dayStart);
      nextDayStart.setDate(dayStart.getDate() + 1);

      if (now < dayStart) {
        dayStart.setDate(dayStart.getDate() - 1);
        nextDayStart.setDate(nextDayStart.getDate() - 1);
      }

      return ts >= dayStart && ts < nextDayStart;
    }

    function getStatus(emp) {
      if (emp.status === "leave") return "On Leave";
      if (emp.is_weekend) return "Weekend";

      if (isTodayTimestamp(emp.check_in)) {
        if (isTodayTimestamp(emp.break_start) && !isTodayTimestamp(emp.break_end)) {
          return "On Break";
        }
        return "Present";
      }

      return "Absent";
    }

    function renderStats() {
      const selectedDept = departmentFilter.value;
      const all = Object.values(employees).filter(e => selectedDept === "all" || e.department === selectedDept);

      const present = all.filter(e => {
        const status = getStatus(e);
        return status === "Present" || status === "On Break";
      }).length;

      const onBreak = all.filter(e => getStatus(e) === "On Break").length;
      const absent = all.filter(e => getStatus(e) === "Absent").length;
      const onLeave = all.filter(e => getStatus(e) === "On Leave").length;
      const weekend = all.filter(e => getStatus(e) === "Weekend").length;

      stats.total.textContent = all.length;
      stats.present.textContent = present;
      stats.absent.textContent = absent;
      stats.onBreak.textContent = onBreak;
      stats.onLeave.textContent = onLeave;
      stats.weekend.textContent = weekend;
    }

    function populateDepartmentFilter() {
      const depts = Array.from(new Set(Object.values(employees).map(e => e.department))).sort();
      departmentFilter.innerHTML = `<option value="all">All Departments</option>`;
      depts.forEach(dep => {
        const option = document.createElement("option");
        option.value = dep;
        option.textContent = dep;
        departmentFilter.appendChild(option);
      });
    }

    function renderTable() {
      employeeList.innerHTML = "";
      const todayStr = new Date().toISOString().slice(5, 10);
      const selectedDept = departmentFilter.value;

      const filtered = Object.values(employees).filter(emp => {
        const matchesDept = selectedDept === "all" || emp.department === selectedDept;
        const status = getStatus(emp);
        const normalizedStatus = status.replace(/\s/g, '').toLowerCase();
        const matchesStatus = selectedStatus === "all" || normalizedStatus === selectedStatus.toLowerCase();
        return matchesDept && matchesStatus;
      });

      filtered.sort((a, b) => {
        const aBirthday = a.birthday && a.birthday.slice(5, 10) === todayStr;
        const bBirthday = b.birthday && b.birthday.slice(5, 10) === todayStr;
        if (aBirthday && !bBirthday) return -1;
        if (!aBirthday && bBirthday) return 1;
        return a.name.localeCompare(b.name);
      });

      filtered.forEach(emp => {
        const tr = document.createElement("tr");

        const status = getStatus(emp);
        const isBirthday = emp.birthday && emp.birthday.slice(5, 10) === todayStr;

        const cols = [
          emp.employee_id || "-",
          isBirthday ? `ðŸŽ‚ ${emp.name}` : emp.name,
          emp.department || "-",
          status,
        ];

        cols.forEach((val, idx) => {
          const td = document.createElement("td");
          td.textContent = val;
          if (idx === 1 && isBirthday) td.classList.add("birthday");
          tr.appendChild(td);
        });

        employeeList.appendChild(tr);
      });
    }

    // Load initial employees JSON from Django context
    const initialEmployees = JSON.parse('{{ employees_json|escapejs }}');
    initialEmployees.forEach(emp => {
      employees[emp.employee_id] = emp;
    });

    populateDepartmentFilter();
    renderStats();
    renderTable();

    function connectWebSocket() {
      const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
      const socket = new WebSocket(protocol + window.location.host + "/ws/admin-dashboard/");

      socket.onmessage = function (event) {
        try {
          const data = JSON.parse(event.data);
          const id = data.employee_id;

          if (!employees[id]) {
            employees[id] = {
              employee_id: id,
              name: data.employee,
              department: data.department,
              birthday: data.birthday,
              status: null,
              check_in: null,
              check_out: null,
              break_start: null,
              break_end: null,
              is_weekend: false,
            };
          }

          const emp = employees[id];

          switch (data.action) {
            case "check_in":
              emp.check_in = data.check_in;
              emp.check_out = null;
              emp.status = null;
              emp.is_weekend = false;
              break;
            case "check_out":
              emp.check_out = data.check_out;
              break;
            case "break_start":
              emp.break_start = data.time;
              emp.break_end = null;
              break;
            case "break_end":
              emp.break_end = data.time;
              break;
            case "leave":
              emp.status = "leave";
              break;
            case "weekend":
              emp.is_weekend = data.is_weekend;
              break;
          }

          populateDepartmentFilter();
          renderStats();
          renderTable();
        } catch (err) {
          console.error("WebSocket error:", err);
        }
      };

      socket.onclose = () => setTimeout(connectWebSocket, 3000);
      socket.onerror = (err) => {
        console.error("WebSocket failure:", err);
        socket.close();
      };
    }

    connectWebSocket();

    departmentFilter.addEventListener("change", () => {
      renderStats();
      renderTable();
    });

    document.querySelectorAll(".card").forEach(card => {
      card.addEventListener("click", () => {
        document.querySelectorAll(".card").forEach(c => c.classList.remove("active"));
        card.classList.add("active");
        selectedStatus = card.dataset.status;
        renderTable();
      });
    });
  </script>
</body>
</html>
















import json
from django.shortcuts import render
from django.utils import timezone
from datetime import time
from .models import Employee, Attendance, Leave, Break

def get_shift_adjusted_datetime_range():
    # Your existing implementation here, just example placeholder
    now = timezone.now()
    start = now.replace(hour=12, minute=0, second=0, microsecond=0)
    if now.hour < 12:
        start = start - timezone.timedelta(days=1)
    end = start + timezone.timedelta(days=1)
    return start, end


def quick_view_dashboard(request):
    start, end = get_shift_adjusted_datetime_range()

    employees_data = []
    employees = Employee.objects.all()

    # Get current date for weekend check
    current_date = start.date()

    for emp in employees:
        attendance = Attendance.objects.filter(employee=emp, check_in__gte=start, check_in__lt=end).first()

        leave = Leave.objects.filter(
            employee=emp,
            start_date__lte=current_date,
            end_date__gte=current_date,
            status="Approved"
        ).first()

        emp_break = Break.objects.filter(employee=emp).order_by('-break_start').first()

        # Check if today is employee's weekend
        # Employee.weekend is a list of day names e.g. ['Saturday', 'Sunday']
        weekday_name = current_date.strftime('%A')  # e.g., "Monday"
        is_weekend = weekday_name in emp.weekend

        employees_data.append({
            "employee_id": emp.employee_id,
            "name": emp.name,
            "department": emp.designation,
            "birthday": emp.birthday.isoformat() if emp.birthday else None,
            "status": "leave" if leave else None,
            "check_in": attendance.check_in.isoformat() if attendance and attendance.check_in else None,
            "check_out": attendance.check_out.isoformat() if attendance and attendance.check_out else None,
            "break_start": emp_break.break_start.isoformat() if emp_break and emp_break.break_start else None,
            "break_end": emp_break.break_end.isoformat() if emp_break and emp_break.break_end else None,
            "is_weekend": is_weekend,
        })

    return render(request, "quick_view_dashboard.html", {
        "employees_json": json.dumps(employees_data)
    })
















<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quick View Dashboard</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background-image: radial-gradient(circle, #000227, #2E0043, rgb(2, 8, 21));
      color: white;
    }

    main {
      padding: 40px 20px;
      max-width: 1400px;
      margin: auto;
    }

    h1 {
      text-align: center;
      color: #ffffff;
      margin-bottom: 20px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .card:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .card.active {
      border: 2px solid #FFD700;
      background: rgba(255, 255, 255, 0.1);
    }

    .card h2 {
      margin: 0;
      font-size: 2rem;
      color: #fff;
    }

    .card p {
      margin: 8px 0 0;
      font-size: 14px;
      color: #aaa;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 10px 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
    }

    thead {
      background-color: #111;
    }

    tbody tr:nth-child(even) {
      background-color: rgba(255, 255, 255, 0.05);
    }

    tbody tr:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .birthday {
      color: gold;
      font-weight: bold;
    }
  </style>
</head>
<body>
<main>
  <h1>Quick View Dashboard</h1>
  <div style="margin: 20px 0; text-align:center;">
    <label for="departmentFilter">Filter by Department: </label>
    <select id="departmentFilter">
      <option value="all">All</option>
    </select>
  </div>

  <div class="stats">
    <div class="card active" data-status="all"><h2 id="totalEmployees">0</h2><p>Total Employees</p></div>
    <div class="card" data-status="present"><h2 id="present">0</h2><p>Present</p></div>
    <div class="card" data-status="absent"><h2 id="absent">0</h2><p>Absent</p></div>
    <div class="card" data-status="onBreak"><h2 id="onBreak">0</h2><p>On Break</p></div>
    <div class="card" data-status="onLeave"><h2 id="onLeave">0</h2><p>On Leave</p></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>User-ID</th>
        <th>Name</th>
        <th>Department</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="employeeList"></tbody>
  </table>
</main>

<script>
  const employeeList = document.getElementById("employeeList");
  const stats = {
    total: document.getElementById("totalEmployees"),
    present: document.getElementById("present"),
    absent: document.getElementById("absent"),
    onBreak: document.getElementById("onBreak"),
    onLeave: document.getElementById("onLeave"),
  };

  const employees = {};
  const departmentFilter = document.getElementById("departmentFilter");
  let selectedStatus = "all";

  function isTodayTimestamp(timestamp) {
    if (!timestamp) return false;
    const ts = new Date(timestamp);
    const now = new Date();

    const dayStart = new Date(now);
    dayStart.setHours(12, 0, 0, 0);

    const nextDayStart = new Date(dayStart);
    nextDayStart.setDate(dayStart.getDate() + 1);

    if (now < dayStart) {
      dayStart.setDate(dayStart.getDate() - 1);
      nextDayStart.setDate(nextDayStart.getDate() - 1);
    }

    return ts >= dayStart && ts < nextDayStart;
  }

  function getStatus(emp) {
    if (emp.status === "leave") return "On Leave";

    if (isTodayTimestamp(emp.check_in)) {
      if (isTodayTimestamp(emp.break_start) && !isTodayTimestamp(emp.break_end)) {
        return "On Break";
      }
      return "Present";
    }

    return "Absent";
  }


  function renderStats() {
    const selectedDept = departmentFilter.value;
    const all = Object.values(employees).filter(e => selectedDept === "all" || e.department === selectedDept);

    const present = all.filter(e => {
      const status = getStatus(e);
      return status === "Present" || status === "On Break";
    }).length;

    const onBreak = all.filter(e => getStatus(e) === "On Break").length;
    const absent = all.filter(e => getStatus(e) === "Absent").length;
    const onLeave = all.filter(e => getStatus(e) === "On Leave").length;

    stats.total.textContent = all.length;
    stats.present.textContent = present;
    stats.absent.textContent = absent;
    stats.onBreak.textContent = onBreak;
    stats.onLeave.textContent = onLeave;
  }


  function populateDepartmentFilter() {
    const depts = Array.from(new Set(Object.values(employees).map(e => e.department))).sort();
    departmentFilter.innerHTML = `<option value="all">All</option>`;
    depts.forEach(dep => {
      const option = document.createElement("option");
      option.value = dep;
      option.textContent = dep;
      departmentFilter.appendChild(option);
    });
  }

  function renderTable() {
    employeeList.innerHTML = "";
    const todayStr = new Date().toISOString().slice(5, 10);
    const selectedDept = departmentFilter.value;

    const filtered = Object.values(employees).filter(emp => {
      const matchesDept = selectedDept === "all" || emp.department === selectedDept;
      const status = getStatus(emp);
      const matchesStatus = selectedStatus === "all" || status.replace(" ", "").toLowerCase() === selectedStatus.toLowerCase();
      return matchesDept && matchesStatus;
    });

    filtered.sort((a, b) => {
      const aBirthday = a.birthday && a.birthday.slice(5, 10) === todayStr;
      const bBirthday = b.birthday && b.birthday.slice(5, 10) === todayStr;
      if (aBirthday && !bBirthday) return -1;
      if (!aBirthday && bBirthday) return 1;
      return a.name.localeCompare(b.name);
    });

    filtered.forEach(emp => {
      const tr = document.createElement("tr");

      const status = getStatus(emp);
      const isBirthday = emp.birthday && emp.birthday.slice(5, 10) === todayStr;

      const cols = [
        emp.employee_id || "-",
        isBirthday ? `ðŸŽ‚ ${emp.name}` : emp.name,
        emp.department || "-",
        status,
      ];

      cols.forEach((val, idx) => {
        const td = document.createElement("td");
        td.textContent = val;
        if (idx === 1 && isBirthday) td.classList.add("birthday");
        tr.appendChild(td);
      });

      employeeList.appendChild(tr);
    });
  }

  // Replace this with actual server-rendered data injection
  const initialEmployees = JSON.parse('{{ employees_json|escapejs }}');
  initialEmployees.forEach(emp => {
    employees[emp.employee_id] = emp;
  });

  populateDepartmentFilter();
  renderStats();
  renderTable();

  function connectWebSocket() {
    const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
    const socket = new WebSocket(protocol + window.location.host + "/ws/admin-dashboard/");

    socket.onmessage = function (event) {
      try {
        const data = JSON.parse(event.data);
        const id = data.employee_id;

        if (!employees[id]) {
          employees[id] = {
            employee_id: id,
            name: data.employee,
            department: data.department,
            birthday: data.birthday,
            status: null,
            check_in: null,
            check_out: null,
            break_start: null,
            break_end: null,
          };
        }

        const emp = employees[id];

        switch (data.action) {
          case "check_in":
            emp.check_in = data.check_in;
            emp.check_out = null;
            break;
          case "check_out":
            emp.check_out = data.check_out;
            break;
          case "break_start":
            emp.break_start = data.time;
            emp.break_end = null;
            break;
          case "break_end":
            emp.break_end = data.time;
            break;
          case "leave":
            emp.status = "leave";
            break;
        }

        populateDepartmentFilter();
        renderStats();
        renderTable();
      } catch (err) {
        console.error("WebSocket error:", err);
      }
    };

    socket.onclose = () => setTimeout(connectWebSocket, 3000);
    socket.onerror = (err) => {
      console.error("WebSocket failure:", err);
      socket.close();
    };
  }

  connectWebSocket();

  departmentFilter.addEventListener("change", () => {
    renderStats();
    renderTable();
  });

  document.querySelectorAll(".card").forEach(card => {
    card.addEventListener("click", () => {
      document.querySelectorAll(".card").forEach(c => c.classList.remove("active"));
      card.classList.add("active");
      selectedStatus = card.dataset.status;
      renderTable();
    });
  });
</script>
</body>
</html>









def quick_view_dashboard(request):
    start, end = get_shift_adjusted_datetime_range()

    employees_data = []
    employees = Employee.objects.all()

    for emp in employees:
        attendance = Attendance.objects.filter(employee=emp, check_in__gte=start, check_in__lt=end).first()

        leave = Leave.objects.filter(
            employee=emp,
            start_date__lte=start.date(),
            end_date__gte=start.date(),
            status="Approved"
        ).first()

        emp_break = Break.objects.filter(employee=emp).order_by('-break_start').first()
        # Optionally check if break_start is within the startâ€“end window.

        employees_data.append({
            "employee_id": emp.employee_id,
            "name": emp.name,
            "department": emp.designation,
            "birthday": emp.birthday.isoformat() if emp.birthday else None,
            "status": "leave" if leave else None,
            "check_in": attendance.check_in.isoformat() if attendance and attendance.check_in else None,
            "check_out": attendance.check_out.isoformat() if attendance and attendance.check_out else None,
            "break_start": emp_break.break_start.isoformat() if emp_break and emp_break.break_start else None,
            "break_end": emp_break.break_end.isoformat() if emp_break and emp_break.break_end else None,
        })

    return render(request, "quick_view_dashboard.html", {
        "employees_json": json.dumps(employees_data)
    })
